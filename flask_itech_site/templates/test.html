<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå - ‡∏Ñ‡∏ì‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .status-present { background-color: #dcfce7; border-color: #16a34a; }
        .status-absent { background-color: #fef2f2; border-color: #dc2626; }
        .status-leave { background-color: #fefce8; border-color: #ca8a04; }
        .nav-btn.active { background-color: #1e40af !important; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-600">
        <div class="container mx-auto px-6 py-4">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
                <p class="text-lg text-gray-600 mt-2">‡∏Ñ‡∏ì‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°</p>
                <p class="text-md text-gray-500">‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°</p>
                <div class="mt-3 bg-blue-50 inline-block px-4 py-2 rounded-lg">
                    <label class="text-sm text-blue-700 font-medium">‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô:</label>
                    <input type="text" id="teacher-name" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå" 
                           class="ml-2 px-2 py-1 border border-blue-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                           onchange="saveTeacherName()">
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Navigation -->
        <nav class="bg-white rounded-lg shadow-md mb-8 p-4">
            <div class="flex flex-wrap justify-center gap-3">
                <button onclick="showPage('csv-upload')" class="nav-btn bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors text-sm">üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î CSV</button>
                <button onclick="showPage('qr-generator')" class="nav-btn bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 transition-colors text-sm">üì± ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code</button>
                <button onclick="showPage('attendance')" class="nav-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">‚úì ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
                <button onclick="showPage('daily-report')" class="nav-btn bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
                <button onclick="showPage('summary')" class="nav-btn bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button onclick="showPage('comparison')" class="nav-btn bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors text-sm">üèÜ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏´‡πâ‡∏≠‡∏á</button>
                <button onclick="showPage('notes')" class="nav-btn bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors text-sm">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</button>
            </div>
        </nav>

        <!-- CSV Upload Page -->
        <div id="csv-upload-page" class="page">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</h2>
                
                <!-- CSV Format Guide -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-blue-800 mb-2">üìã ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</h3>
                    <p class="text-blue-700 mb-2">‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
                    <div class="bg-white p-3 rounded border text-sm font-mono">
                        student_id,name,level,major<br>
                        6501001,‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ,‡∏õ‡∏ß‡∏ä,‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå<br>
                        6501002,‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏õ‡∏ß‡∏™,‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏•<br>
                    </div>
                    <p class="text-blue-600 text-sm mt-2">
                        <strong>level:</strong> "‡∏õ‡∏ß‡∏ä" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏õ‡∏ß‡∏™"<br>
                        <strong>major:</strong> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ
                    </p>
                </div>

                <!-- File Upload -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</label>
                    <div class="flex items-center justify-center w-full">
                        <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-8 h-8 mb-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span> ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á</p>
                                <p class="text-xs text-gray-500">CSV ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                            </div>
                            <input type="file" id="csv-file" accept=".csv" class="hidden" onchange="handleCSVUpload(this)">
                        </label>
                    </div>
                </div>

                <!-- Preview -->
                <div id="csv-preview" class="hidden mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200" id="preview-table">
                            <!-- Table content will be inserted here -->
                        </table>
                    </div>
                    <div class="mt-4 flex gap-4">
                        <button onclick="importCSVData()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            ‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                        <button onclick="clearCSVPreview()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                            ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    </div>
                </div>

                <!-- Current Data Summary -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <h4 class="font-semibold text-blue-800">‡∏£‡∏∞‡∏î‡∏±‡∏ö ‡∏õ‡∏ß‡∏ä.</h4>
                            <p class="text-2xl font-bold text-blue-600" id="pvt-count">0</p>
                            <p class="text-sm text-blue-600">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg">
                            <h4 class="font-semibold text-green-800">‡∏£‡∏∞‡∏î‡∏±‡∏ö ‡∏õ‡∏ß‡∏™.</h4>
                            <p class="text-2xl font-bold text-green-600" id="pvs-count">0</p>
                            <p class="text-sm text-green-600">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Generator Page -->
        <div id="qr-generator-page" class="page hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                        <select id="qr-level" onchange="updateQRMajors()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö --</option>
                            <option value="‡∏õ‡∏ß‡∏ä">‡∏õ‡∏ß‡∏ä.</option>
                            <option value="‡∏õ‡∏ß‡∏™">‡∏õ‡∏ß‡∏™.</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <select id="qr-major" onchange="loadStudentsForQR()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ç‡∏ô‡∏≤‡∏î QR Code</label>
                        <select id="qr-size" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="200">‡πÄ‡∏•‡πá‡∏Å (200x200)</option>
                            <option value="300" selected>‡∏Å‡∏•‡∏≤‡∏á (300x300)</option>
                            <option value="400">‡πÉ‡∏´‡∏ç‡πà (400x400)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <button onclick="generateAllQRCodes()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors mr-4">
                        üì± ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                    <button onclick="downloadAllQRCodes()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </div>

                <!-- QR Codes Grid -->
                <div id="qr-codes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="col-span-full text-gray-500 text-center py-8">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code</p>
                </div>
            </div>
        </div>

        <!-- Attendance Page -->
        <div id="attendance-page" class="page hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                
                <!-- Course Selection -->
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                        <select id="attendance-level" onchange="updateAttendanceMajors()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö --</option>
                            <option value="‡∏õ‡∏ß‡∏ä">‡∏õ‡∏ß‡∏ä.</option>
                            <option value="‡∏õ‡∏ß‡∏™">‡∏õ‡∏ß‡∏™.</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <select id="attendance-major" onchange="loadStudents()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="date" id="attendance-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <button onclick="markAll('present')" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        ‚úì ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)
                    </button>
                    <button onclick="markAll('absent')" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        ‚úó ‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                    <button onclick="clearAll()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        üîÑ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                    <button onclick="saveAttendance()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>

                <!-- Students List -->
                <div id="students-list" class="space-y-3">
                    <p class="text-gray-500 text-center py-8">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                </div>
            </div>
        </div>

        <!-- Daily Report Page -->
        <div id="daily-report-page" class="page hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
                
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="report-date" onchange="generateDailyReport()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                        <select id="report-level" onchange="updateReportMajors()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö --</option>
                            <option value="‡∏õ‡∏ß‡∏ä">‡∏õ‡∏ß‡∏ä.</option>
                            <option value="‡∏õ‡∏ß‡∏™">‡∏õ‡∏ß‡∏™.</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <select id="report-major" onchange="generateDailyReport()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                        </select>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <canvas id="dailyChart" width="400" height="300"></canvas>
                    </div>
                    <div id="daily-stats" class="space-y-4">
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h3 class="font-semibold text-green-800">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                            <p class="text-2xl font-bold text-green-600" id="present-count">0</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <h3 class="font-semibold text-red-800">‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                            <p class="text-2xl font-bold text-red-600" id="absent-count">0</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h3 class="font-semibold text-yellow-800">‡∏•‡∏≤</h3>
                            <p class="text-2xl font-bold text-yellow-600" id="leave-count">0</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h3 class="font-semibold text-blue-800">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                            <p class="text-2xl font-bold text-blue-600" id="attendance-percentage">0%</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Page -->
        <div id="summary-page" class="page hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                        <select id="summary-level" onchange="updateSummaryMajors()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö --</option>
                            <option value="‡∏õ‡∏ß‡∏ä">‡∏õ‡∏ß‡∏ä.</option>
                            <option value="‡∏õ‡∏ß‡∏™">‡∏õ‡∏ß‡∏™.</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <select id="summary-major" onchange="generateSummary()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                        </select>
                    </div>
                </div>

                <div id="summary-content">
                    <p class="text-gray-500 text-center py-8">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </div>
            </div>
        </div>

        <!-- Comparison Page -->
        <div id="comparison-page" class="page hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                    <select id="comparison-level" onchange="generateComparisonChart()" class="w-full max-w-md p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö --</option>
                        <option value="‡∏õ‡∏ß‡∏ä">‡∏õ‡∏ß‡∏ä.</option>
                        <option value="‡∏õ‡∏ß‡∏™">‡∏õ‡∏ß‡∏™.</option>
                        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <canvas id="comparisonChart" width="400" height="300"></canvas>
                    </div>
                    <div id="comparison-stats" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center py-8">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Page -->
        <div id="notes-page" class="page hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                        <select id="notes-level" onchange="updateNotesMajors()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö --</option>
                            <option value="‡∏õ‡∏ß‡∏ä">‡∏õ‡∏ß‡∏ä.</option>
                            <option value="‡∏õ‡∏ß‡∏™">‡∏õ‡∏ß‡∏™.</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <select id="notes-major" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="notes-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                    <input type="text" id="notes-title" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô, ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô, ‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                    <textarea id="notes-content" rows="8" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏û‡∏§‡∏ï‡∏¥ ‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <button onclick="saveNotes()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>

                <div class="mt-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</h3>
                    <div id="notes-history" class="space-y-4 max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md mx-4">
            <div class="text-center">
                <div class="text-green-600 text-6xl mb-4">‚úì</div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h3>
                <div id="success-summary" class="text-left bg-gray-50 p-4 rounded-lg mb-6">
                    <!-- Summary content will be inserted here -->
                </div>
                <button onclick="closeModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    ‡∏ï‡∏Å‡∏•‡∏á
                </button>
            </div>
        </div>
    </div>

    <script>
        // Major data
        const majorsData = {
            '‡∏õ‡∏ß‡∏ä': [
                '‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå',
                '‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤',
                '‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°',
                '‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏ô‡∏ï‡πå',
                '‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤',
                '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏•‡∏´‡∏∞',
                '‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏•‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô',
                '‡∏ä‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á',
                '‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°',
                '‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
                '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•',
                '‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•',
                '‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î'
            ],
            '‡∏õ‡∏ß‡∏™': [
                '‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏• (‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á)',
                '‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤',
                '‡πÑ‡∏ü‡∏ü‡πâ‡∏≤',
                '‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå',
                '‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°',
                '‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÇ‡∏•‡∏´‡∏∞',
                '‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤',
                '‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏•',
                '‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï',
                '‡∏ä‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á',
                '‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°',
                '‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
                '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•',
                '‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î',
                '‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•'
            ]
        };

        // Student data storage
        let studentsData = JSON.parse(localStorage.getItem('studentsData')) || {};
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || {};
        let notesData = JSON.parse(localStorage.getItem('notesData')) || [];
        let csvPreviewData = [];
        let qrCodesData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('attendance-date').valueAsDate = new Date();
            document.getElementById('report-date').valueAsDate = new Date();
            document.getElementById('notes-date').valueAsDate = new Date();
            
            // Load teacher name
            const savedTeacherName = localStorage.getItem('teacherName');
            if (savedTeacherName) {
                document.getElementById('teacher-name').value = savedTeacherName;
            }
            
            updateStudentCounts();
            loadNotesHistory();
        });

        // Save teacher name
        function saveTeacherName() {
            const teacherName = document.getElementById('teacher-name').value;
            localStorage.setItem('teacherName', teacherName);
        }

        // Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId + '-page').classList.remove('hidden');
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Update major dropdowns based on level selection
        function updateQRMajors() {
            updateMajorDropdown('qr-level', 'qr-major');
        }

        function updateAttendanceMajors() {
            updateMajorDropdown('attendance-level', 'attendance-major');
        }

        function updateReportMajors() {
            updateMajorDropdown('report-level', 'report-major');
        }

        function updateSummaryMajors() {
            updateMajorDropdown('summary-level', 'summary-major');
        }

        function updateNotesMajors() {
            updateMajorDropdown('notes-level', 'notes-major');
        }

        function updateMajorDropdown(levelId, majorId) {
            const level = document.getElementById(levelId).value;
            const majorSelect = document.getElementById(majorId);
            
            majorSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>';
            
            if (level && majorsData[level]) {
                majorsData[level].forEach(major => {
                    const option = document.createElement('option');
                    option.value = major;
                    option.textContent = major;
                    majorSelect.appendChild(option);
                });
            }
        }

        // Get course key
        function getCourseKey(level, major) {
            return `${level}-${major}`;
        }

        // Load students based on selected course
        function loadStudents() {
            const level = document.getElementById('attendance-level').value;
            const major = document.getElementById('attendance-major').value;
            const studentsList = document.getElementById('students-list');

            if (!level || !major) {
                studentsList.innerHTML = '<p class="text-gray-500 text-center py-8">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
                return;
            }

            const courseKey = getCourseKey(level, major);
            const students = studentsData[courseKey] || [];
            const currentDate = document.getElementById('attendance-date').value;
            
            if (students.length === 0) {
                studentsList.innerHTML = '<p class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô</p>';
                return;
            }
            
            let html = '';
            students.forEach(student => {
                const attendanceKey = `${courseKey}-${currentDate}-${student.id}`;
                const currentStatus = attendanceData[attendanceKey] || '';
                
                html += `
                    <div class="student-row border rounded-lg p-4 ${getStatusClass(currentStatus)}" data-student-id="${student.id}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden">
                                        ${student.image ? `<img src="${student.image}" alt="${student.name}" class="w-full h-full object-cover">` : `<span class="text-gray-500">üë§</span>`}
                                    </div>
                                    <button onclick="uploadImage('${student.id}')" class="absolute -bottom-1 -right-1 bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-blue-600" title="‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ">
                                        üì∑
                                    </button>
                                    <input type="file" id="image-${student.id}" accept="image/*" class="hidden" onchange="handleImageUpload('${student.id}', this)">
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-800">${student.name}</h3>
                                    <p class="text-sm text-gray-600">‡∏£‡∏´‡∏±‡∏™: ${student.id}</p>
                                    <p class="text-xs text-blue-600">${level} ${major}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="setStatus('${student.id}', 'present')" class="status-btn px-4 py-2 rounded-lg border-2 transition-colors ${currentStatus === 'present' ? 'bg-green-500 text-white border-green-500' : 'bg-white text-green-600 border-green-300 hover:bg-green-50'}">
                                    ‚úì ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                                </button>
                                <button onclick="setStatus('${student.id}', 'absent')" class="status-btn px-4 py-2 rounded-lg border-2 transition-colors ${currentStatus === 'absent' ? 'bg-red-500 text-white border-red-500' : 'bg-white text-red-600 border-red-300 hover:bg-red-50'}">
                                    ‚úó ‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                                </button>
                                <button onclick="setStatus('${student.id}', 'leave')" class="status-btn px-4 py-2 rounded-lg border-2 transition-colors ${currentStatus === 'leave' ? 'bg-yellow-500 text-white border-yellow-500' : 'bg-white text-yellow-600 border-yellow-300 hover:bg-yellow-50'}">
                                    üìã ‡∏•‡∏≤
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            studentsList.innerHTML = html;
        }

        // Get status class for row styling
        function getStatusClass(status) {
            switch(status) {
                case 'present': return 'status-present border-green-300';
                case 'absent': return 'status-absent border-red-300';
                case 'leave': return 'status-leave border-yellow-300';
                default: return 'border-gray-200';
            }
        }

        // Set attendance status
        function setStatus(studentId, status) {
            const level = document.getElementById('attendance-level').value;
            const major = document.getElementById('attendance-major').value;
            const currentDate = document.getElementById('attendance-date').value;
            
            if (!level || !major || !currentDate) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö ‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
                return;
            }

            const courseKey = getCourseKey(level, major);
            const attendanceKey = `${courseKey}-${currentDate}-${studentId}`;
            attendanceData[attendanceKey] = status;
            
            // Update row styling
            const row = document.querySelector(`[data-student-id="${studentId}"]`);
            row.className = `student-row border rounded-lg p-4 ${getStatusClass(status)}`;
            
            // Update button states
            const buttons = row.querySelectorAll('.status-btn');
            buttons.forEach(btn => {
                btn.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'text-white');
                btn.classList.add('bg-white');
            });
            
            const activeButton = row.querySelector(`button[onclick*="'${status}'"]`);
            if (activeButton) {
                activeButton.classList.remove('bg-white');
                activeButton.classList.add('text-white');
                if (status === 'present') activeButton.classList.add('bg-green-500');
                else if (status === 'absent') activeButton.classList.add('bg-red-500');
                else if (status === 'leave') activeButton.classList.add('bg-yellow-500');
            }
        }

        // Mark all students with specific status
        function markAll(status) {
            const level = document.getElementById('attendance-level').value;
            const major = document.getElementById('attendance-major').value;
            
            if (!level || !major) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤');
                return;
            }

            const courseKey = getCourseKey(level, major);
            const students = studentsData[courseKey] || [];
            students.forEach(student => {
                setStatus(student.id, status);
            });
        }

        // Clear all attendance
        function clearAll() {
            const level = document.getElementById('attendance-level').value;
            const major = document.getElementById('attendance-major').value;
            const currentDate = document.getElementById('attendance-date').value;
            
            if (!level || !major || !currentDate) return;

            const courseKey = getCourseKey(level, major);
            const students = studentsData[courseKey] || [];
            students.forEach(student => {
                const attendanceKey = `${courseKey}-${currentDate}-${student.id}`;
                delete attendanceData[attendanceKey];
            });
            
            loadStudents();
        }

        // Upload image
        function uploadImage(studentId) {
            document.getElementById(`image-${studentId}`).click();
        }

        function handleImageUpload(studentId, input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Find student and update image
                    Object.keys(studentsData).forEach(courseKey => {
                        const student = studentsData[courseKey].find(s => s.id === studentId);
                        if (student) {
                            student.image = e.target.result;
                        }
                    });
                    
                    // Save to localStorage
                    localStorage.setItem('studentsData', JSON.stringify(studentsData));
                    loadStudents();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Save attendance
        function saveAttendance() {
            const level = document.getElementById('attendance-level').value;
            const major = document.getElementById('attendance-major').value;
            const currentDate = document.getElementById('attendance-date').value;
            
            if (!level || !major || !currentDate) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö ‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
                return;
            }

            const courseKey = getCourseKey(level, major);
            
            // Save to localStorage
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // Calculate summary
            const students = studentsData[courseKey] || [];
            let present = 0, absent = 0, leave = 0;
            
            students.forEach(student => {
                const attendanceKey = `${courseKey}-${currentDate}-${student.id}`;
                const status = attendanceData[attendanceKey];
                if (status === 'present') present++;
                else if (status === 'absent') absent++;
                else if (status === 'leave') leave++;
            });

            // Calculate total statistics
            const totalDays = getTotalAttendanceDays(courseKey);
            const totalScore = calculateTotalScore(courseKey);
            const maxScore = students.length * totalDays;
            const percentage = maxScore > 0 ? ((totalScore / maxScore) * 100).toFixed(1) : 0;

            // Show success modal
            const currentTime = new Date().toLocaleString('th-TH');
            const summaryHtml = `
                <div class="space-y-2">
                    <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${formatThaiDate(currentDate)}</p>
                    <p><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${currentTime}</p>
                    <p><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö:</strong> ${level}</p>
                    <p><strong>‡∏™‡∏≤‡∏Ç‡∏≤:</strong> ${major}</p>
                    <p><strong>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</strong></p>
                    <div class="ml-4">
                        <p class="text-green-600">‚Ä¢ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${present} ‡∏Ñ‡∏ô</p>
                        <p class="text-red-600">‚Ä¢ ‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${absent} ‡∏Ñ‡∏ô</p>
                        <p class="text-yellow-600">‚Ä¢ ‡∏•‡∏≤: ${leave} ‡∏Ñ‡∏ô</p>
                    </div>
                    <hr class="my-3">
                    <p><strong>‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°:</strong></p>
                    <div class="ml-4">
                        <p>‚Ä¢ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß: ${totalDays} ‡∏ß‡∏±‡∏ô</p>
                        <p>‚Ä¢ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${totalScore.toFixed(1)}/${maxScore} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
                        <p>‚Ä¢ ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${percentage}%</p>
                    </div>
                </div>
            `;
            
            document.getElementById('success-summary').innerHTML = summaryHtml;
            document.getElementById('success-modal').classList.remove('hidden');
            document.getElementById('success-modal').classList.add('flex');
        }

        // Helper functions
        function getTotalAttendanceDays(courseKey) {
            const dates = new Set();
            Object.keys(attendanceData).forEach(key => {
                if (key.startsWith(courseKey + '-')) {
                    const parts = key.split('-');
                    if (parts.length >= 5) {
                        const date = parts[2] + '-' + parts[3] + '-' + parts[4];
                        dates.add(date);
                    }
                }
            });
            return dates.size;
        }

        function calculateTotalScore(courseKey) {
            let totalScore = 0;
            Object.keys(attendanceData).forEach(key => {
                if (key.startsWith(courseKey + '-')) {
                    const status = attendanceData[key];
                    if (status === 'present') totalScore += 1;
                    else if (status === 'leave') totalScore += 0.5;
                }
            });
            return totalScore;
        }

        function formatThaiDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function closeModal() {
            document.getElementById('success-modal').classList.add('hidden');
            document.getElementById('success-modal').classList.remove('flex');
        }

        // Daily report functions
        function generateDailyReport() {
            const reportDate = document.getElementById('report-date').value;
            const reportLevel = document.getElementById('report-level').value;
            const reportMajor = document.getElementById('report-major').value;
            
            if (!reportDate || !reportLevel || !reportMajor) return;

            const courseKey = getCourseKey(reportLevel, reportMajor);
            const students = studentsData[courseKey] || [];
            let present = 0, absent = 0, leave = 0;
            
            students.forEach(student => {
                const attendanceKey = `${courseKey}-${reportDate}-${student.id}`;
                const status = attendanceData[attendanceKey];
                if (status === 'present') present++;
                else if (status === 'absent') absent++;
                else if (status === 'leave') leave++;
            });

            const total = present + absent + leave;
            const percentage = total > 0 ? ((present + leave * 0.5) / total * 100).toFixed(1) : 0;

            // Update stats
            document.getElementById('present-count').textContent = present;
            document.getElementById('absent-count').textContent = absent;
            document.getElementById('leave-count').textContent = leave;
            document.getElementById('attendance-percentage').textContent = percentage + '%';

            // Update chart
            const ctx = document.getElementById('dailyChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡∏•‡∏≤'],
                    datasets: [{
                        data: [present, absent, leave],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Summary functions
        function generateSummary() {
            const level = document.getElementById('summary-level').value;
            const major = document.getElementById('summary-major').value;
            
            if (!level || !major) return;

            const courseKey = getCourseKey(level, major);
            const students = studentsData[courseKey] || [];
            const summaryContent = document.getElementById('summary-content');
            
            if (students.length === 0) {
                summaryContent.innerHTML = '<p class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ</p>';
                return;
            }
            
            let html = '<div class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-200">';
            html += '<thead class="bg-gray-50"><tr>';
            html += '<th class="px-4 py-2 border text-left">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>';
            html += '<th class="px-4 py-2 border text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>';
            html += '<th class="px-4 py-2 border text-center">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>';
            html += '<th class="px-4 py-2 border text-center">‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>';
            html += '<th class="px-4 py-2 border text-center">‡∏•‡∏≤</th>';
            html += '<th class="px-4 py-2 border text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>';
            html += '<th class="px-4 py-2 border text-center">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô</th>';
            html += '</tr></thead><tbody>';

            students.forEach(student => {
                let present = 0, absent = 0, leave = 0;
                
                Object.keys(attendanceData).forEach(key => {
                    if (key.includes(courseKey) && key.endsWith(student.id)) {
                        const status = attendanceData[key];
                        if (status === 'present') present++;
                        else if (status === 'absent') absent++;
                        else if (status === 'leave') leave++;
                    }
                });

                const totalDays = present + absent + leave;
                const score = present + (leave * 0.5);
                const percentage = totalDays > 0 ? ((score / totalDays) * 100).toFixed(1) : 0;

                html += `<tr class="hover:bg-gray-50">`;
                html += `<td class="px-4 py-2 border">${student.id}</td>`;
                html += `<td class="px-4 py-2 border">${student.name}</td>`;
                html += `<td class="px-4 py-2 border text-center text-green-600">${present}</td>`;
                html += `<td class="px-4 py-2 border text-center text-red-600">${absent}</td>`;
                html += `<td class="px-4 py-2 border text-center text-yellow-600">${leave}</td>`;
                html += `<td class="px-4 py-2 border text-center font-semibold">${score.toFixed(1)}/${totalDays}</td>`;
                html += `<td class="px-4 py-2 border text-center font-semibold ${percentage >= 80 ? 'text-green-600' : percentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">${percentage}%</td>`;
                html += `</tr>`;
            });

            html += '</tbody></table></div>';
            summaryContent.innerHTML = html;
        }

        // Comparison chart
        function generateComparisonChart() {
            const level = document.getElementById('comparison-level').value;
            if (!level) return;

            const ctx = document.getElementById('comparisonChart').getContext('2d');
            const comparisonStats = document.getElementById('comparison-stats');
            
            let majorsToShow = [];
            let chartData = [];
            let statsHtml = '';

            if (level === 'all') {
                // Show all majors from both levels
                Object.keys(majorsData).forEach(lvl => {
                    majorsData[lvl].forEach(major => {
                        majorsToShow.push(`${lvl} ${major}`);
                    });
                });
            } else {
                majorsToShow = majorsData[level].map(major => `${level} ${major}`);
            }

            majorsToShow.forEach(majorDisplay => {
                const [lvl, ...majorParts] = majorDisplay.split(' ');
                const major = majorParts.join(' ');
                const courseKey = getCourseKey(lvl, major);
                const students = studentsData[courseKey] || [];
                
                if (students.length > 0) {
                    const totalScore = calculateTotalScore(courseKey);
                    const totalDays = getTotalAttendanceDays(courseKey);
                    const maxScore = students.length * totalDays;
                    const percentage = maxScore > 0 ? ((totalScore / maxScore) * 100) : 0;
                    
                    chartData.push({
                        label: majorDisplay,
                        percentage: percentage.toFixed(1),
                        studentCount: students.length
                    });

                    const colorClass = percentage >= 80 ? 'bg-green-100 border-green-200 text-green-800' : 
                                     percentage >= 60 ? 'bg-yellow-100 border-yellow-200 text-yellow-800' : 
                                     'bg-red-100 border-red-200 text-red-800';

                    statsHtml += `
                        <div class="${colorClass} p-3 rounded-lg border">
                            <h4 class="font-semibold text-sm">${majorDisplay}</h4>
                            <p class="text-xl font-bold">${percentage.toFixed(1)}%</p>
                            <p class="text-xs">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${students.length} ‡∏Ñ‡∏ô</p>
                        </div>
                    `;
                }
            });

            comparisonStats.innerHTML = statsHtml || '<p class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';

            if (chartData.length > 0) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.map(d => d.label),
                        datasets: [{
                            label: '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                            data: chartData.map(d => parseFloat(d.percentage)),
                            backgroundColor: chartData.map(d => {
                                const pct = parseFloat(d.percentage);
                                return pct >= 80 ? '#10b981' : pct >= 60 ? '#f59e0b' : '#ef4444';
                            }),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }

        // Notes functions
        function saveNotes() {
            const level = document.getElementById('notes-level').value;
            const major = document.getElementById('notes-major').value;
            const date = document.getElementById('notes-date').value;
            const title = document.getElementById('notes-title').value;
            const content = document.getElementById('notes-content').value;

            if (!level || !major || !date || !title || !content) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            const note = {
                id: Date.now(),
                level: level,
                major: major,
                date: date,
                title: title,
                content: content,
                timestamp: new Date().toISOString()
            };

            notesData.unshift(note);
            localStorage.setItem('notesData', JSON.stringify(notesData));

            // Clear form
            document.getElementById('notes-title').value = '';
            document.getElementById('notes-content').value = '';

            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            loadNotesHistory();
        }

        function loadNotesHistory() {
            const historyDiv = document.getElementById('notes-history');
            if (notesData.length === 0) {
                historyDiv.innerHTML = '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>';
                return;
            }

            let html = '';
            notesData.forEach(note => {
                html += `
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-gray-800">${note.title}</h4>
                            <span class="text-sm text-gray-500">${formatThaiDate(note.date)}</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-2">${note.level} ${note.major}</p>
                        <p class="text-gray-700">${note.content}</p>
                    </div>
                `;
            });
            historyDiv.innerHTML = html;
        }

        // CSV Upload Functions
        function handleCSVUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                Papa.parse(csv, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV');
                            console.error(results.errors);
                            return;
                        }
                        
                        csvPreviewData = results.data;
                        showCSVPreview(csvPreviewData);
                    }
                });
            };
            reader.readAsText(file, 'UTF-8');
        }

        function showCSVPreview(data) {
            if (data.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV');
                return;
            }

            // Validate required columns
            const requiredColumns = ['student_id', 'name', 'level', 'major'];
            const columns = Object.keys(data[0]);
            const missingColumns = requiredColumns.filter(col => !columns.includes(col));
            
            if (missingColumns.length > 0) {
                alert(`‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ${missingColumns.join(', ')}`);
                return;
            }

            // Show preview
            document.getElementById('csv-preview').classList.remove('hidden');
            
            let html = '<thead class="bg-gray-50"><tr>';
            html += '<th class="px-4 py-2 border text-left">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>';
            html += '<th class="px-4 py-2 border text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>';
            html += '<th class="px-4 py-2 border text-left">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>';
            html += '<th class="px-4 py-2 border text-left">‡∏™‡∏≤‡∏Ç‡∏≤</th>';
            html += '<th class="px-4 py-2 border text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>';
            html += '</tr></thead><tbody>';

            data.forEach((row, index) => {
                const isValidLevel = ['‡∏õ‡∏ß‡∏ä', '‡∏õ‡∏ß‡∏™'].includes(row.level);
                const isValidMajor = isValidLevel && majorsData[row.level] && majorsData[row.level].includes(row.major);
                const isValid = row.student_id && row.name && isValidLevel && isValidMajor;
                
                const statusClass = isValid ? 'text-green-600' : 'text-red-600';
                const statusText = isValid ? '‚úì ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' : '‚úó ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                
                html += `<tr class="hover:bg-gray-50">`;
                html += `<td class="px-4 py-2 border">${row.student_id || '-'}</td>`;
                html += `<td class="px-4 py-2 border">${row.name || '-'}</td>`;
                html += `<td class="px-4 py-2 border">${row.level || '-'}</td>`;
                html += `<td class="px-4 py-2 border">${row.major || '-'}</td>`;
                html += `<td class="px-4 py-2 border text-center ${statusClass}">${statusText}</td>`;
                html += `</tr>`;
            });

            html += '</tbody>';
            document.getElementById('preview-table').innerHTML = html;
        }

        function importCSVData() {
            if (csvPreviewData.length === 0) return;

            // Validate and import data
            let importCount = 0;
            csvPreviewData.forEach(row => {
                const isValidLevel = ['‡∏õ‡∏ß‡∏ä', '‡∏õ‡∏ß‡∏™'].includes(row.level);
                const isValidMajor = isValidLevel && majorsData[row.level] && majorsData[row.level].includes(row.major);
                
                if (row.student_id && row.name && isValidLevel && isValidMajor) {
                    const courseKey = getCourseKey(row.level, row.major);
                    
                    // Check if student already exists
                    if (!studentsData[courseKey]) {
                        studentsData[courseKey] = [];
                    }
                    
                    const existingStudent = studentsData[courseKey].find(s => s.id === row.student_id);
                    if (!existingStudent) {
                        studentsData[courseKey].push({
                            id: row.student_id,
                            name: row.name,
                            level: row.level,
                            major: row.major,
                            image: null
                        });
                        importCount++;
                    }
                }
            });

            // Save to localStorage
            localStorage.setItem('studentsData', JSON.stringify(studentsData));
            
            alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${importCount} ‡∏Ñ‡∏ô`);
            clearCSVPreview();
            updateStudentCounts();
        }

        function clearCSVPreview() {
            document.getElementById('csv-preview').classList.add('hidden');
            document.getElementById('csv-file').value = '';
            csvPreviewData = [];
        }

        function updateStudentCounts() {
            let pvtCount = 0, pvsCount = 0;
            
            Object.keys(studentsData).forEach(courseKey => {
                if (courseKey.startsWith('‡∏õ‡∏ß‡∏ä-')) {
                    pvtCount += studentsData[courseKey].length;
                } else if (courseKey.startsWith('‡∏õ‡∏ß‡∏™-')) {
                    pvsCount += studentsData[courseKey].length;
                }
            });
            
            document.getElementById('pvt-count').textContent = pvtCount;
            document.getElementById('pvs-count').textContent = pvsCount;
        }

        // QR Code Functions
        function loadStudentsForQR() {
            const level = document.getElementById('qr-level').value;
            const major = document.getElementById('qr-major').value;
            
            if (!level || !major) {
                document.getElementById('qr-codes-grid').innerHTML = '<p class="col-span-full text-gray-500 text-center py-8">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code</p>';
                return;
            }
        }

        function generateAllQRCodes() {
            const level = document.getElementById('qr-level').value;
            const major = document.getElementById('qr-major').value;
            const size = parseInt(document.getElementById('qr-size').value);
            
            if (!level || !major) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤');
                return;
            }

            const courseKey = getCourseKey(level, major);
            const students = studentsData[courseKey] || [];
            
            if (students.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ');
                return;
            }

            const grid = document.getElementById('qr-codes-grid');
            grid.innerHTML = '';
            qrCodesData = [];

            students.forEach(student => {
                const qrData = {
                    studentId: student.id,
                    studentName: student.name,
                    level: student.level,
                    major: student.major,
                    timestamp: new Date().toISOString()
                };

                const qrString = JSON.stringify(qrData);
                
                // Create QR code container
                const qrContainer = document.createElement('div');
                qrContainer.className = 'bg-white border rounded-lg p-4 text-center shadow-sm';
                
                // Create canvas for QR code
                const canvas = document.createElement('canvas');
                canvas.id = `qr-${student.id}`;
                
                // Generate QR code
                QRCode.toCanvas(canvas, qrString, {
                    width: size,
                    height: size,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function(error) {
                    if (error) {
                        console.error('QR Code generation error:', error);
                        return;
                    }
                    
                    qrContainer.innerHTML = `
                        <div class="mb-3">
                            <h3 class="font-semibold text-gray-800 text-sm">${student.name}</h3>
                            <p class="text-xs text-gray-600">${student.id}</p>
                            <p class="text-xs text-blue-600">${student.level} ${student.major}</p>
                        </div>
                        <div class="flex justify-center mb-3"></div>
                        <button onclick="downloadSingleQR('${student.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 transition-colors">
                            üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                        </button>
                    `;
                    
                    qrContainer.querySelector('.flex.justify-center').appendChild(canvas);
                    grid.appendChild(qrContainer);
                    
                    // Store QR data for batch download
                    qrCodesData.push({
                        studentId: student.id,
                        studentName: student.name,
                        canvas: canvas,
                        dataUrl: canvas.toDataURL('image/png')
                    });
                });
            });
        }

        function downloadSingleQR(studentId) {
            const qrData = qrCodesData.find(qr => qr.studentId === studentId);
            if (!qrData) return;

            const link = document.createElement('a');
            link.download = `QR_${qrData.studentId}_${qrData.studentName.replace(/\s+/g, '_')}.png`;
            link.href = qrData.dataUrl;
            link.click();
        }

        function downloadAllQRCodes() {
            if (qrCodesData.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            // Create a simple batch download
            qrCodesData.forEach((qrData, index) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.download = `QR_${qrData.studentId}_${qrData.studentName.replace(/\s+/g, '_')}.png`;
                    link.href = qrData.dataUrl;
                    link.click();
                }, index * 500); // Delay each download by 500ms
            });
            
            alert(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î QR Code ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${qrCodesData.length} ‡πÑ‡∏ü‡∏•‡πå`);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96297879b23b8966',t:'MTc1MzA4ODAzNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
